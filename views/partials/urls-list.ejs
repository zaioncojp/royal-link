<section class="urls-section">
  <div class="card">
    <div class="card-header">
      <h2><i class="fas fa-chart-line"></i> 短縮URL一覧</h2>
    </div>
    <div class="card-body">
      <% if (urls && urls.length > 0) { %>
        <!-- タブ -->
        <div class="tabs">
          <button class="tab-btn active" data-tab="list">リスト表示</button>
          <button class="tab-btn" data-tab="analytics">アクセス統計</button>
        </div>
        
        <!-- URL一覧タブ -->
        <div id="list-tab" class="tab-panel active">
          <div class="url-list">
            <div class="table-responsive">
              <table>
                <thead>
                  <tr>
                    <th>元URL</th>
                    <th>短縮URL</th>
                    <th>クリック数</th>
                    <th>作成日</th>
                    <th>アクション</th>
                  </tr>
                </thead>
                <tbody>
                  <% for (let i = 0; i < urls.length; i++) { %>
                    <tr>
                      <td class="original-url" title="<%= urls[i].originalUrl %>">
                        <%= urls[i].originalUrl.length > 30 ? urls[i].originalUrl.substring(0, 30) + '...' : urls[i].originalUrl %>
                      </td>
                      <td>
                        <% 
                          const domain = typeof appDomain !== 'undefined' ? appDomain : 'king-rule.site';
                          let shortUrl = '';
                          if (urls[i].customSlug) {
                            shortUrl = `https://${domain}/${urls[i].customSlug}`;
                          } else {
                            shortUrl = `https://${domain}/s/${urls[i].shortCode}`;
                          }
                        %>
                        <a href="<%= shortUrl %>" target="_blank">
                          <%= shortUrl %>
                        </a>
                        <button class="copy-btn" data-url="<%= shortUrl %>">
                          <i class="fas fa-copy"></i>
                        </button>
                      </td>
                      <td><%= urls[i].clicks || 0 %></td>
                      <td><%= new Date(urls[i].createdAt).toLocaleDateString() %></td>
                      <td>
                        <div class="action-buttons">
                          <a href="/urls/detail/<%= urls[i]._id %>" class="btn-small btn-info" title="詳細">
                            <i class="fas fa-chart-bar"></i>
                          </a>
                          <a href="/urls/delete/<%= urls[i]._id %>" class="btn-small btn-danger" title="削除" onclick="return confirm('このURLを削除してもよろしいですか？');">
                            <i class="fas fa-trash"></i>
                          </a>
                        </div>
                      </td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- アクセス統計タブ -->
        <div id="analytics-tab" class="tab-panel">
          <div class="analytics-chart">
            <h3>時間帯別アクセス統計</h3>
            <div class="chart-container">
              <% 
                // 時間帯別のクリック数集計
                const hourlyStats = Array(24).fill(0);
                
                urls.forEach(url => {
                  if (url.accessLogs && url.accessLogs.length > 0) {
                    url.accessLogs.forEach(log => {
                      const hour = new Date(log.timestamp).getHours();
                      hourlyStats[hour]++;
                    });
                  }
                });
                
                const maxHourlyClicks = Math.max(...hourlyStats, 1);
              %>
              
              <% for (let i = 0; i < 24; i++) { %>
                <div class="chart-bar">
                  <div class="bar" style="height: <%= Math.max(20, (hourlyStats[i] / maxHourlyClicks) * 250) %>px">
                    <span class="clicks"><%= hourlyStats[i] %></span>
                  </div>
                  <span class="code"><%= i %>:00</span>
                </div>
              <% } %>
            </div>
          </div>
          
          <div class="analytics-chart mt-4">
            <h3>人気の短縮URL</h3>
            <div class="chart-container">
              <% 
                // クリック数の多い順にソート
                const sortedUrls = [...urls].sort((a, b) => (b.clicks || 0) - (a.clicks || 0)).slice(0, 10);
                const maxClicks = Math.max(...sortedUrls.map(url => url.clicks || 0), 1);
              %>
              
              <% for (let i = 0; i < sortedUrls.length && i < 8; i++) { %>
                <div class="chart-bar">
                  <div class="bar popular-bar" style="height: <%= Math.max(20, ((sortedUrls[i].clicks || 0) / maxClicks) * 250) %>px">
                    <span class="clicks"><%= sortedUrls[i].clicks || 0 %></span>
                  </div>
                  <span class="code" title="<%= sortedUrls[i].originalUrl %>">
                    <%= sortedUrls[i].customSlug || sortedUrls[i].shortCode %>
                  </span>
                </div>
              <% } %>
            </div>
          </div>
        </div>
      <% } else { %>
        <p class="no-data">短縮URLがありません。上のフォームからURLを短縮してください。</p>
      <% } %>
    </div>
  </div>
</section>

<script>
  // コピーボタン機能を追加
  document.addEventListener('DOMContentLoaded', function() {
    const copyButtons = document.querySelectorAll('.copy-btn');
    
    copyButtons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        const url = this.getAttribute('data-url');
        
        navigator.clipboard.writeText(url)
          .then(() => {
            // コピー成功時の表示
            const originalHTML = this.innerHTML;
            this.innerHTML = '<i class="fas fa-check"></i>';
            this.classList.add('copied');
            
            setTimeout(() => {
              this.innerHTML = originalHTML;
              this.classList.remove('copied');
            }, 2000);
          })
          .catch(err => {
            console.error('コピーに失敗しました:', err);
          });
      });
    });
  });
</script>

<style>
  /* URL一覧と統計タブ専用スタイル */
  .original-url {
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .copy-btn {
    background: none;
    border: none;
    color: var(--primary-color);
    cursor: pointer;
    font-size: 1rem;
    padding: 0.25rem;
    margin-left: 0.5rem;
    border-radius: 4px;
    transition: all 0.3s;
  }
  
  .copy-btn:hover {
    background: rgba(110, 142, 251, 0.2);
  }
  
  .copy-btn.copied {
    color: var(--success-color);
  }
  
  .action-buttons {
    display: flex;
    gap: 0.5rem;
  }
  
  /* アクセス統計 */
  .analytics-chart {
    background: rgba(26, 32, 44, 0.4);
    border-radius: 8px;
    padding: 1.5rem;
    margin-top: 1rem;
  }
  
  .analytics-chart h3 {
    margin-bottom: 1.5rem;
    color: var(--light-color);
    font-size: 1.1rem;
    text-align: center;
    opacity: 0.9;
  }
  
  .chart-container {
    display: flex;
    justify-content: space-around;
    align-items: flex-end;
    height: 300px;
    padding-bottom: 2rem;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  
  .chart-bar {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 40px;
    margin: 0 0.2rem;
  }
  
  .bar {
    width: 40px;
    background: var(--primary-gradient);
    border-radius: 8px 8px 0 0;
    position: relative;
    box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.1), 0 0 10px rgba(110, 142, 251, 0.3);
    min-height: 20px;
    transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    animation: growUp 1s ease-out forwards;
  }
  
  @keyframes growUp {
    from { height: 0; }
    to { height: auto; }
  }
  
  .bar.popular-bar {
    background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
    box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.1), 0 0 10px rgba(255, 107, 107, 0.3);
  }
  
  .clicks {
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(26, 32, 44, 0.8);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    white-space: nowrap;
  }
  
  .code {
    margin-top: 0.5rem;
    font-size: 0.75rem;
    color: var(--light-color);
    opacity: 0.7;
    max-width: 65px;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .mt-4 {
    margin-top: 2rem;
  }
  
  .tabs {
    display: flex;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid var(--glass-border);
  }
  
  .tab-btn {
    padding: 0.75rem 1.5rem;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--light-color);
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    opacity: 0.7;
  }
  
  .tab-btn:hover {
    opacity: 1;
  }
  
  .tab-btn.active {
    opacity: 1;
    border-bottom-color: var(--primary-color);
    color: var(--primary-light);
  }
  
  .tab-panel {
    display: none;
  }
  
  .tab-panel.active {
    display: block;
    animation: fadeIn 0.5s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>